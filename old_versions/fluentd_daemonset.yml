---
- name: Deploy Fluentd Logging Agent
  hosts: localhost
  connection: local
  tasks:
    - name: Create Fluentd Service Account
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: fluentd
            namespace: logging

    - name: Create ClusterRole for Fluentd
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: fluentd
          rules:
          - apiGroups: [""]
            resources: ["pods", "namespaces"]
            verbs: ["get", "list", "watch"]

    - name: Bind ClusterRole to ServiceAccount
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: fluentd
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: fluentd
          subjects:
          - kind: ServiceAccount
            name: fluentd
            namespace: logging

    - name: Deploy Fluentd DaemonSet
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: fluentd
            namespace: logging
          spec:
            selector:
              matchLabels:
                app: fluentd
            template:
              metadata:
                labels:
                  app: fluentd
              spec:
                serviceAccountName: fluentd
                containers:
                - name: fluentd
                  image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
                  env:
                    - name:  FLUENT_ELASTICSEARCH_HOST
                      value: "elasticsearch.logging.svc.cluster.local"
                    - name:  FLUENT_ELASTICSEARCH_PORT
                      value: "9200"
                    - name:  FLUENT_ELASTICSEARCH_SCHEME
                      value: "http"
                  resources:
                    limits:
                      memory: 200Mi
                    requests:
                      cpu: 100m
                      memory: 200Mi
                volumes:
                - name: varlog
                  hostPath:
                    path: /var/log
                - name: varlibdockercontainers
                  hostPath:
                    path: /var/lib/docker/containers
